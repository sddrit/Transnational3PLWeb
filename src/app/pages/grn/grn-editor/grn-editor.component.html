<div class="dx-card responsive-paddings">

	<dx-button class="btn-back" type="back" (onClick)="backToGrnList()">
	</dx-button>

	<h2>Good Received Note</h2>

	<p *ngIf="grn.id != 0"><b>GRN : </b> {{grn.grnNo}}</p>
	<p *ngIf="grn.id != 0"><b>Date : </b> {{grn.created | date: 'yyyy-MM-dd'}}</p>

	<br/>

	<form (submit)="handleSubmit($event)">

		<dx-form [readOnly]="grn.id != 0" id="form" [(formData)]="grn" method="post" labelLocation="top" [colCount]="4">
			<dxi-item itemType="group" caption="General Details" [colSpan]="4" [colCount]="6">

				<dxi-item editorType="dxSelectBox" [colSpan]="2"
						  [editorOptions]="{ dataSource: purchaseOrderStore, displayExpr: 'poNumber', valueExpr: 'id', searchEnabled: true, searchExpr: ['poNumber'],
						  						onValueChanged: onPurchaseOrderChange }"
						  [label]="{ text: 'PO Number' }" dataField="purchaseOrderId" [isRequired]="false">
				</dxi-item>

				<dxi-item editorType="dxLookup" [colSpan]="2"
						  [editorOptions]="{ dataSource: warehouseStore, displayExpr: 'name', valueExpr: 'id', searchEnabled: true, searchExpr: ['code', 'name'],
					fieldTemplate: 'warehouseField', itemTemplate: 'warehouseField'}"
						  [label]="{ text: 'Warehouse' }" dataField="wareHouseId" [isRequired]="true">
				</dxi-item>

				<dxi-item editorType="dxLookup" [colSpan]="2"
						  [editorOptions]="{ dataSource: supplierStore, displayExpr: 'supplierName', valueExpr: 'id', searchEnabled: true, searchExpr: ['code', 'supplierName'],
					  fieldTemplate: 'supplierField', itemTemplate: 'supplierField'  }"
						  [label]="{ text: 'Supplier' }" dataField="supplierId" [isRequired]="true">
				</dxi-item>

			</dxi-item>

			<div *dxTemplate="let item of 'supplierField'">
				<div>{{item?.code}} - {{item?.supplierName}}</div>
			</div>

			<div *dxTemplate="let item of 'warehouseField'">
				<div>{{item?.code}} - {{item?.name}}</div>
			</div>

			<dxi-item itemType="group" caption="GRN Items" [colSpan]="4">
				<dxi-item>
					<dx-data-grid (onRowValidating)="onRowValidating($event)"
								  [disabled]="grn.supplierId == 0"
								  [dataSource]="grn.goodReceivedNoteItems"
								  [showBorders]="true"
								  [rowAlternationEnabled]="true">
						<dxo-editing
							[allowUpdating]="grn.id == 0"
							[allowAdding]="grn.id == 0"
							[allowDeleting]="grn.id == 0"
							mode="cell">
						</dxo-editing>
						<dxi-column caption="Product Name" dataField="productId">
							<dxi-validation-rule type="required" message="Product is required"></dxi-validation-rule>
							<dxo-lookup
								[dataSource]="{ store: productStore, filter: [['supplierId', '=', grn.supplierId], ['active', '=', true]] }"
								displayExpr="name"
								valueExpr="id">
							</dxo-lookup>
						</dxi-column>
						<dxi-column dataType="date" format="dd/MM/yyyy" [width]="200" dataField="expiredDate">
						</dxi-column>
						<dxi-column dataType="number" [width]="200" dataField="quantity">
							<dxi-validation-rule type="required" message="Quantity is required"></dxi-validation-rule>
						</dxi-column>
						<dxi-column dataType="number" [width]="200" dataField="unitCost">
							<dxi-validation-rule type="required" message="Unit Cost is required"></dxi-validation-rule>
						</dxi-column>
						<dxi-column [allowEditing]="false" name="total" alignment="right" dataType="total" caption="Total" [width]="200" [calculateCellValue]='calcualteTotal'></dxi-column>
						<dxo-summary>
							<dxi-total-item
								alignment="right"
								displayFormat="Quantity Total : {0}"
								column="quantity"
								summaryType="sum">
							</dxi-total-item>
							<dxi-total-item
								alignment="right"
								displayFormat="Total : {0}"
								column="total"
								summaryType="sum">
							</dxi-total-item>
						</dxo-summary>
					</dx-data-grid>
				</dxi-item>
			</dxi-item>

			<dxi-item class="btn-save-product" [colSpan]="4" itemType="button"
					  [buttonOptions]="{ text: 'Save Changes', useSubmitBehavior: true, type: 'success', icon: 'save', class: 'btn-save-product', visible: grn.id == 0 }">
			</dxi-item>
		</dx-form>
	</form>


</div>
